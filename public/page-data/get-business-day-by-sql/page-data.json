{"componentChunkName":"component---src-templates-blog-post-js","path":"/get-business-day-by-sql/","result":{"data":{"site":{"siteMetadata":{"title":"分かりやすい技術ブログ"}},"allFile":{"edges":[]},"mdx":null,"mdPrevious":null,"mdNext":null,"wpPost":{"id":"cG9zdDoyMjMz","title":"平日や営業日を取得するSQL(Postgress/Oracle)","content":"\n<p>業務を行う上では、休日を除いた日付を取得したいことがあるかと思います。<br> これが地味に難しいですが、そこそこキレイに取得できたので紹介します。 </p>\n\n\n\n<p>当然ですが、祝日を除いた営業日を取得したい場合は、「祝日マスタ」のようなテーブルで情報を保持している必要があります。</p>\n\n\n\n<h3 class=\"wp-block-heading\">前提</h3>\n\n\n\n<p>ここでの祝日マスタは以下の形式とします。</p>\n\n\n\n<table class=\"wp-block-table aligncenter is-style-stripes\"><tbody><tr><td>ID</td><td>HOLIDAY</td></tr><tr><td>1</td><td>2019-01-14</td></tr><tr><td>2</td><td>2019-02-11</td></tr><tr><td>3</td><td>2019-03-21</td></tr><tr><td>4</td><td>2019-04-29</td></tr><tr><td>5</td><td>2019-04-30</td></tr><tr><td>6</td><td>2019-05-01</td></tr><tr><td>7</td><td>2019-05-02</td></tr><tr><td>8</td><td>2019-05-03</td></tr><tr><td>9</td><td>2019-05-06</td></tr></tbody></table>\n\n\n\n<h2 class=\"wp-block-heading\">実装SQL</h2>\n\n\n\n<p>日付取得に関する要件は色々とあるかと思いますが、ここでは「前営業日を取得する」ことを提示します。翌営業日などほかの要件もこれの応用で取得できると思います。</p>\n\n\n\n<p>ちなみにこれらSQLでの肝は日付候補を複数レコードとして取得することで、Postgressでは generate_series関数というのがとても便利で、Oracleでは同じようなことをlevel疑似列で行います。</p>\n\n\n\n<h3 class=\"wp-block-heading\">Postgress版</h3>\n\n\n\n<p>使い方としては、WITH句で前営業日を取得するようにしているので、以降はその一時テーブルから簡単なSELECT文で取得できます。</p>\n\n\n\n<script src=\"https://gist.github.com/nisioka/476c1ef6ec6bc5d8cd9feb8fd02b3c53.js\"></script>\n\n\n\n<p>コメントにも記載していますが、解説もします。まず元となるレコード群とするためにgenerate_series関数で候補数分取得します(ここでは15レコード分)。それらを本日日付(current_date)から引くことで前日から16日前までの候補日付となります。</p>\n\n\n\n<p>そこから絞り混みを行い、(曜日を取得する関数)で土日を除き、祝日マスタに該当しないことをもって祝日を除きます。そうして残ったものが営業日のみの日付候補となるので、max関数を用いて前営業日を取得しています。</p>\n\n\n\n<p>これらから少し修正すれば、翌営業日だったり、土日以外が休みなどにも変更できます。</p>\n\n\n\n<h3 class=\"wp-block-heading\">Oracle版</h3>\n\n\n\n<p>Oracle版も基本は同じです。generate_seriesがlevel疑似列に変わっています。</p>\n\n\n\n<script src=\"https://gist.github.com/nisioka/ff5b29b2b555df3b482a002347a55bf5.js\"></script>\n\n\n\n<h2 class=\"wp-block-heading\">終わりに</h2>\n\n\n\n<p>そもそも理想を言えば、必要な年月分(10年分とか)のカレンダーを保持して、その日付が休みかどうかのフラグを持っているのが楽です。それを今回はWITH句の中で一時的に作り出しています。</p>\n\n\n\n<p>これから機能設計する場合はそうしたカレンダーベースの営業日の保持の仕方をすることをお勧めします。</p>\n","excerpt":"<p>業務を行う上では、休日を除いた日付を取得したいことがあるかと思います。 これが地味に難しいですが、そこそこキレイに取得できたので紹介します。 当然ですが、祝日を除いた営業日を取得したい場合は、「祝日マスタ」のようなテーブ [&hellip;]</p>\n","slug":"get-business-day-by-sql","date":"2019/08/27","featuredImage":{"node":{"altText":"","gatsbyImage":{"images":{"sources":[{"srcSet":"/_gatsby/image/42c9a8453274db52f67de103c8355bc5/b10eb8e5115c490b6dcbd793ff52614f/cropped-sql.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D116%26h%3D65%26fm%3Davif%26q%3D75&cd=3de9a4069b38659ce4ae47294911f180 116w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/c978c571e6c31082ec0555ff039339af/cropped-sql.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D231%26h%3D130%26fm%3Davif%26q%3D75&cd=3de9a4069b38659ce4ae47294911f180 231w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/4ebaf6ecfac10334ee7fc7ca2a6d3be5/cropped-sql.avif?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D462%26h%3D260%26fm%3Davif%26q%3D75&cd=3de9a4069b38659ce4ae47294911f180 462w","type":"image/avif","sizes":"(min-width: 462px) 462px, 100vw"},{"srcSet":"/_gatsby/image/42c9a8453274db52f67de103c8355bc5/1ca6b4b92e18744f5394255e7a7233f2/cropped-sql.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D116%26h%3D65%26fm%3Dwebp%26q%3D75&cd=3de9a4069b38659ce4ae47294911f180 116w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/2483e52e5b6847bc69cc8d4dd6a48c89/cropped-sql.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D231%26h%3D130%26fm%3Dwebp%26q%3D75&cd=3de9a4069b38659ce4ae47294911f180 231w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/c314adc6080c99a64d141e9b69604cfc/cropped-sql.webp?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D462%26h%3D260%26fm%3Dwebp%26q%3D75&cd=3de9a4069b38659ce4ae47294911f180 462w","type":"image/webp","sizes":"(min-width: 462px) 462px, 100vw"}],"fallback":{"src":"/_gatsby/image/42c9a8453274db52f67de103c8355bc5/f3558527a8b074eeaf43403b03bc580e/cropped-sql.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D116%26h%3D65%26fm%3Djpg%26q%3D75&cd=3de9a4069b38659ce4ae47294911f180","srcSet":"/_gatsby/image/42c9a8453274db52f67de103c8355bc5/f3558527a8b074eeaf43403b03bc580e/cropped-sql.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D116%26h%3D65%26fm%3Djpg%26q%3D75&cd=3de9a4069b38659ce4ae47294911f180 116w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/1e49abc8946abe72be228e62bc4dc2ec/cropped-sql.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D231%26h%3D130%26fm%3Djpg%26q%3D75&cd=3de9a4069b38659ce4ae47294911f180 231w,/_gatsby/image/42c9a8453274db52f67de103c8355bc5/0dc6fef9c273a74c585a81c038e58ae6/cropped-sql.jpg?u=http%3A%2F%2Flocalhost%2Fwp-content%2Fuploads%2F2019%2F08%2Fcropped-sql.jpg&a=w%3D462%26h%3D260%26fm%3Djpg%26q%3D75&cd=3de9a4069b38659ce4ae47294911f180 462w","sizes":"(min-width: 462px) 462px, 100vw"}},"layout":"constrained","width":462,"height":260,"backgroundColor":"rgb(200,216,216)"}}}},"wpPrevious":{"title":"Go Conference 2019 Autumn セッション資料まとめ","slug":"go-conference-2019-autumn"},"wpNext":{"title":"【書評】ドラゴンクエストXを支える技術","slug":"dragon-quest-x"}},"pageContext":{"id":"cG9zdDoyMjMz","previousPostId":"cG9zdDoyMjYx","nextPostId":"cG9zdDoyMTMz","imagePath":null}},"staticQueryHashes":["2841359383"],"slicesMap":{}}